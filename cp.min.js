!function(){var r;Object.create=Object.create||function(t){function i(){}return i.prototype=t,new i},"undefined"==typeof exports?(r={},"object"==typeof window&&(window.cp=r)):r=exports;var A,B,v=function(t,i){if(!t)throw new Error("Assertion failed: "+i)},g=function(t,i){!t&&console&&console.warn&&(console.warn("ASSERTION FAILED: "+i),console.trace&&console.trace())};B="object"==typeof window&&-1<window.navigator.userAgent.indexOf("Firefox")?(A=Math.min,Math.max):(A=function(t,i){return t<i?t:i},function(t,i){return i<t?t:i});var w=function(t,i){return t<i?t+" "+i:i+" "+t},o=function(t,i){for(var e=0;e<t.length;e++)if(t[e]===i)return t[e]=t[t.length-1],void t.length--};r.momentForCircle=function(t,i,e,s){return t*(.5*(i*i+e*e)+Q(s))},r.areaForCircle=function(t,i){return Math.PI*Math.abs(t*t-i*i)},r.momentForSegment=function(t,i,e){var s=L(I(i,e),.5);return t*(n(e,i)/12+Q(s))},r.areaForSegment=function(t,i,e){return e*(Math.PI*e+2*V(t,i))},r.momentForPoly=function(t,i,e){for(var s=0,n=0,r=i.length,o=0;o<r;o+=2){var a=i[o]+e.x,h=i[o+1]+e.y,c=i[(o+2)%r]+e.x,p=i[(o+3)%r]+e.y,u=F(c,p,a,h);s+=u*(M(a,h,a,h)+M(a,h,c,p)+M(c,p,c,p)),n+=u}return t*s/(6*n)},r.areaForPoly=function(t){for(var i=0,e=0,s=t.length;e<s;e+=2)i+=N(new S(t[e],t[e+1]),new S(t[(e+2)%s],t[(e+3)%s]));return-i/2},r.centroidForPoly=function(t){for(var i=0,e=new S(0,0),s=0,n=t.length;s<n;s+=2){var r=new S(t[s],t[s+1]),o=new S(t[(s+2)%n],t[(s+3)%n]),a=N(r,o);i+=a,e=I(e,L(I(r,o),a))}return L(e,1/(3*i))},r.recenterPoly=function(t){for(var i=r.centroidForPoly(t),e=0;e<t.length;e+=2)t[e]-=i.x,t[e+1]-=i.y},r.momentForBox=function(t,i,e){return t*(i*i+e*e)/12},r.momentForBox2=function(t,i){var e=i.r-i.l,s=i.t-i.b,n=L(r.v(i.l+i.r,i.b+i.t),.5);return r.momentForBox(t,e,s)+t*Q(n)};var u=r.loopIndexes=function(t){var i,e,s,n,r=0,o=0;i=s=t[0],e=n=t[1];for(var a=t.length>>1,h=1;h<a;h++){var c=t[2*h],p=t[2*h+1];c<i||c==i&&p<e?(i=c,e=p,r=h):(s<c||c==s&&n<p)&&(s=c,n=p,o=h)}return[r,o]},y=function(t,i,e){var s=t[2*i];t[2*i]=t[2*e],t[2*e]=s,s=t[2*i+1],t[2*i+1]=t[2*e+1],t[2*e+1]=s},f=function(t,i,e,s,n,r){if(0===e)return 0;for(var o=0,a=i,h=x(n,s),c=r*_(h),p=i,u=i+e-1;p<=u;){var l=new S(t[2*p],t[2*p+1]),b=N(h,x(l,s));c<b?(o<b&&(o=b,a=p),p++):(y(t,p,u),u--)}return a!=i&&y(t,i,a),p-i},d=function(t,i,e,s,n,r,o,a){if(s<0)return 0;if(0==s)return i[2*a]=r.x,i[2*a+1]=r.y,1;var h=f(i,e,s,n,r,t),c=new S(i[2*e],i[2*e+1]),p=d(t,i,e+1,h-1,n,c,r,a),u=a+p++;i[2*u]=r.x,i[2*u+1]=r.y;var l=f(i,e+h,s-h,r,o,t),b=new S(i[2*(e+h)],i[2*(e+h)+1]);return p+d(t,i,e+h+1,l-1,r,b,o,a+p)};r.convexHull=function(t,i,e){if(i)for(var s=0;s<t.length;s++)i[s]=t[s];else i=t;var n=u(t),r=n[0],o=n[1];if(r==o)return i.length=2,i;y(i,0,r),y(i,1,0==o?r:o);var a=new S(i[0],i[1]),h=new S(i[2],i[3]),c=t.length>>1,p=d(e,i,2,c-2,a,h,a,1)+1;return i.length=2*p,g(U(i),"Internal error: cpConvexHull() and cpPolyValidate() did not agree.Please report this error with as much info as you can."),i};var C=function(t,i,e){return A(B(t,i),e)},m=function(t){return B(0,A(t,1))},S=r.Vect=function(t,i){this.x=t,this.y=i};r.v=function(t,i){return new S(t,i)};var j=r.vzero=new S(0,0),k=r.v.dot=function(t,i){return t.x*i.x+t.y*i.y},M=function(t,i,e,s){return t*e+i*s},_=r.v.len=function(t){return Math.sqrt(k(t,t))},a=r.v.len2=function(t,i){return Math.sqrt(t*t+i*i)},I=(r.v.eql=function(t,i){return t.x===i.x&&t.y===i.y},r.v.add=function(t,i){return new S(t.x+i.x,t.y+i.y)});S.prototype.add=function(t){return this.x+=t.x,this.y+=t.y,this};var x=r.v.sub=function(t,i){return new S(t.x-i.x,t.y-i.y)};S.prototype.sub=function(t){return this.x-=t.x,this.y-=t.y,this};var P=r.v.neg=function(t){return new S(-t.x,-t.y)};S.prototype.neg=function(){return this.x=-this.x,this.y=-this.y,this};var L=r.v.mult=function(t,i){return new S(t.x*i,t.y*i)};S.prototype.mult=function(t){return this.x*=t,this.y*=t,this};var N=r.v.cross=function(t,i){return t.x*i.y-t.y*i.x},F=function(t,i,e,s){return t*s-i*e},p=r.v.perp=function(t){return new S(-t.y,t.x)},s=(r.v.pvrperp=function(t){return new S(t.y,-t.x)},r.v.project=function(t,i){return L(i,k(t,i)/Q(i))});S.prototype.project=function(t){return this.mult(k(this,t)/Q(t)),this};var c=r.v.rotate=function(t,i){return new S(t.x*i.x-t.y*i.y,t.x*i.y+t.y*i.x)};S.prototype.rotate=function(t){return this.x=this.x*t.x-this.y*t.y,this.y=this.x*t.y+this.y*t.x,this};var i=r.v.unrotate=function(t,i){return new S(t.x*i.x+t.y*i.y,t.y*i.x-t.x*i.y)},Q=r.v.lengthsq=function(t){return k(t,t)},T=r.v.lengthsq2=function(t,i){return t*t+i*i},R=r.v.lerp=function(t,i,e){return I(L(t,1-e),L(i,e))},l=r.v.normalize=function(t){return L(t,1/_(t))},h=r.v.normalize_safe=function(t){return 0===t.x&&0===t.y?j:l(t)},b=r.v.clamp=function(t,i){return k(t,t)>i*i?L(l(t),i):t},V=(r.v.lerpconst=function(t,i,e){return I(t,b(x(i,t),e))},r.v.dist=function(t,i){return _(x(t,i))}),n=r.v.distsq=function(t,i){return Q(x(t,i))},O=(r.v.near=function(t,i,e){return n(t,i)<e*e},r.v.slerp=function(t,i,e){var s=Math.acos(k(t,i));if(s){var n=1/Math.sin(s);return I(L(t,Math.sin((1-e)*s)*n),L(i,Math.sin(e*s)*n))}return t}),q=(r.v.slerpconst=function(t,i,e){var s=Math.acos(k(t,i));return O(t,i,A(e,s)/s)},r.v.forangle=function(t){return new S(Math.cos(t),Math.sin(t))},r.v.toangle=function(t){return Math.atan2(t.y,t.x)},r.v.str=function(t){return"("+t.x.toFixed(3)+", "+t.y.toFixed(3)+")"},r.BB=function(t,i,e,s){this.l=t,this.b=i,this.r=e,this.t=s,0});r.bb=function(t,i,e,s){return new q(t,i,e,s)};var E=function(t,i){return new q(t.x-i,t.y-i,t.x+i,t.y+i)},e=0,H=(r.NO_GROUP=0,r.ALL_LAYERS=-1);r.resetShapeIdCounter=function(){e=0};var D=r.Shape=function(t){this.body=t,this.bb_l=this.bb_b=this.bb_r=this.bb_t=0,this.hashid=e++,this.sensor=!1,this.e=0,this.u=0,this.surface_v=j,this.collision_type=0,this.group=0,this.layers=H,this.space=null,this.collisionCode=this.collisionCode};D.prototype.setElasticity=function(t){this.e=t},D.prototype.setFriction=function(t){this.body.activate(),this.u=t},D.prototype.setLayers=function(t){this.body.activate(),this.layers=t},D.prototype.setSensor=function(t){this.body.activate(),this.sensor=t},D.prototype.setCollisionType=function(t){this.body.activate(),this.collision_type=t},D.prototype.getBody=function(){return this.body},D.prototype.active=function(){return this.body&&-1!==this.body.shapeList.indexOf(this)},D.prototype.setBody=function(t){v(!this.active(),"You cannot change the body on an active shape. You must remove the shape from the space before changing the body."),this.body=t},D.prototype.cacheBB=function(){return this.update(this.body.p,this.body.rot)},D.prototype.update=function(t,i){v(!isNaN(i.x),"Rotation is NaN"),v(!isNaN(t.x),"Position is NaN"),this.cacheData(t,i)},D.prototype.pointQuery=function(t){var i=this.nearestPointQuery(t);if(i.d<0)return i},D.prototype.getBB=function(){return new q(this.bb_l,this.bb_b,this.bb_r,this.bb_t)};var G=function(t,i,e){this.shape=t,this.p=i,this.d=e},W=function(t,i,e){this.shape=t,this.t=i,this.n=e};W.prototype.hitPoint=function(t,i){return R(t,i,this.t)},W.prototype.hitDist=function(t,i){return V(t,i)*this.t};var t=r.CircleShape=function(t,i,e){this.c=this.tc=e,this.r=i,this.type="circle",D.call(this,t)};t.prototype=Object.create(D.prototype),t.prototype.cacheData=function(t,i){var e=this.tc=c(this.c,i).add(t),s=this.r;this.bb_l=e.x-s,this.bb_b=e.y-s,this.bb_r=e.x+s,this.bb_t=e.y+s},t.prototype.nearestPointQuery=function(t){var i=t.x-this.tc.x,e=t.y-this.tc.y,s=a(i,e),n=this.r,r=new S(this.tc.x+i*n/s,this.tc.y+e*n/s);return new G(this,r,s-n)};var z=function(t,i,e,s,n,r){s=x(s,i),n=x(n,i);var o=k(s,s)-2*k(s,n)+k(n,n),a=-2*k(s,s)+2*k(s,n),h=a*a-4*o*(k(s,s)-e*e);if(0<=h){var c=(-a-Math.sqrt(h))/(2*o);if(0<=c&&c<=1)return new W(t,c,l(R(s,n,c)))}};t.prototype.segmentQuery=function(t,i){return z(this,this.tc,this.r,t,i)};var J=r.SegmentShape=function(t,i,e,s){this.a=i,this.b=e,this.n=p(l(x(e,i))),this.ta=this.tb=this.tn=null,this.r=s,this.a_tangent=j,this.b_tangent=j,this.type="segment",D.call(this,t)};J.prototype=Object.create(D.prototype),J.prototype.cacheData=function(t,i){var e,s,n,r;this.ta=I(t,c(this.a,i)),this.tb=I(t,c(this.b,i)),this.tn=c(this.n,i),s=this.ta.x<this.tb.x?(e=this.ta.x,this.tb.x):(e=this.tb.x,this.ta.x),r=this.ta.y<this.tb.y?(n=this.ta.y,this.tb.y):(n=this.tb.y,this.ta.y);var o=this.r;this.bb_l=e-o,this.bb_b=n-o,this.bb_r=s+o,this.bb_t=r+o},J.prototype.nearestPointQuery=function(t){var i=function(t,i,e){var s=x(i,e),n=m(k(s,x(t,e))/Q(s));return I(e,L(s,n))}(t,this.ta,this.tb),e=t.x-i.x,s=t.y-i.y,n=a(e,s),r=this.r,o=n?I(i,L(new S(e,s),r/n)):i;return new G(this,o,n-r)},J.prototype.segmentQuery=function(t,i){var e=this.tn,s=k(x(this.ta,t),e),n=this.r,r=0<s?P(e):e,o=x(L(r,n),t),a=I(this.ta,o),h=I(this.tb,o),c=x(i,t);if(N(c,a)*N(c,h)<=0){var p=s+(0<s?-n:n),u=-p,l=k(c,e)-p;if(u*l<0)return new W(this,u/(u-l),r)}else if(0!==n){var b=z(this,this.ta,this.r,t,i),y=z(this,this.tb,this.r,t,i);return b?y&&y.t<b.t?y:b:y}},J.prototype.setNeighbors=function(t,i){this.a_tangent=x(t,this.a),this.b_tangent=x(i,this.b)},J.prototype.setEndpoints=function(t,i){this.a=t,this.b=i,this.n=p(l(x(i,t)))};var U=function(t){for(var i=t.length,e=0;e<i;e+=2){var s=t[e],n=t[e+1],r=t[(e+2)%i],o=t[(e+3)%i],a=t[(e+4)%i],h=t[(e+5)%i];if(0<F(r-s,o-n,a-r,h-o))return!1}return!0},Y=r.PolyShape=function(t,i,e){this.setVerts(i,e),this.type="poly",D.call(this,t)};Y.prototype=Object.create(D.prototype);var K=function(t,i){this.n=t,this.d=i};K.prototype.compare=function(t){return k(this.n,t)-this.d},Y.prototype.setVerts=function(t,i){v(4<=t.length,"Polygons require some verts"),v("number"==typeof t[0],"Polygon verticies should be specified in a flattened list (eg [x1,y1,x2,y2,x3,y3,...])"),v(U(t),"Polygon is concave or has a reversed winding. Consider using cpConvexHull()");var e=t.length,s=e>>1;this.verts=new Array(e),this.tVerts=new Array(e),this.planes=new Array(s),this.tPlanes=new Array(s);for(var n=0;n<e;n+=2){var r=t[n]+i.x,o=t[n+1]+i.y,a=t[(n+2)%e]+i.x,h=t[(n+3)%e]+i.y,c=l(p(new S(a-r,h-o)));this.verts[n]=r,this.verts[n+1]=o,this.planes[n>>1]=new K(c,M(c.x,c.y,r,o)),this.tPlanes[n>>1]=new K(new S(0,0),0)}};r.BoxShape=function(t,i,e){var s=i/2,n=e/2;return X(t,new q(-s,-n,s,n))};var X=r.BoxShape2=function(t,i){var e=[i.l,i.b,i.l,i.t,i.r,i.t,i.r,i.b];return new Y(t,e,j)};Y.prototype.transformVerts=function(t,i){for(var e=this.verts,s=this.tVerts,n=1/0,r=-1/0,o=1/0,a=-1/0,h=0;h<e.length;h+=2){var c=e[h],p=e[h+1],u=t.x+c*i.x-p*i.y,l=t.y+c*i.y+p*i.x;s[h]=u,s[h+1]=l,n=A(n,u),r=B(r,u),o=A(o,l),a=B(a,l)}this.bb_l=n,this.bb_b=o,this.bb_r=r,this.bb_t=a},Y.prototype.transformAxes=function(t,i){for(var e=this.planes,s=this.tPlanes,n=0;n<e.length;n++){var r=c(e[n].n,i);s[n].n=r,s[n].d=k(t,r)+e[n].d}},Y.prototype.cacheData=function(t,i){this.transformAxes(t,i),this.transformVerts(t,i)},Y.prototype.nearestPointQuery=function(t){for(var i,e,s,n,r,o,a,h=this.tPlanes,c=this.tVerts,p=c[c.length-2],u=c[c.length-1],l=1/0,b=j,y=!1,v=0;v<h.length;v++){0<h[v].compare(t)&&(y=!0);var f=c[2*v],d=c[2*v+1],_=(i=t.x,e=t.y,void 0,a=m(M(r=p-(s=f),o=u-(n=d),i-s,e-n)/T(r,o)),new S(s+r*a,n+o*a)),x=V(t,_);x<l&&(l=x,b=_),p=f,u=d}return new G(this,b,y?l:-l)},Y.prototype.segmentQuery=function(t,i){for(var e=this.tPlanes,s=this.tVerts,n=e.length,r=2*n,o=0;o<n;o++){var a=e[o].n,h=k(t,a);if(!(e[o].d>h)){var c=k(i,a),p=(e[o].d-h)/(c-h);if(!(p<0||1<p)){var u=R(t,i,p),l=-N(a,u),b=-F(a.x,a.y,s[2*o],s[2*o+1]),y=-F(a.x,a.y,s[(2*o+2)%r],s[(2*o+3)%r]);if(b<=l&&l<=y)return new W(this,p,a)}}}},Y.prototype.valueOnAxis=function(t,i){for(var e=this.tVerts,s=M(t.x,t.y,e[0],e[1]),n=2;n<e.length;n+=2)s=A(s,M(t.x,t.y,e[n],e[n+1]));return s-i},Y.prototype.containsVert=function(t,i){for(var e=this.tPlanes,s=0;s<e.length;s++){var n=e[s].n;if(0<M(n.x,n.y,t,i)-e[s].d)return!1}return!0},Y.prototype.containsVertPartial=function(t,i,e){for(var s=this.tPlanes,n=0;n<s.length;n++){var r=s[n].n;if(!(k(r,e)<0))if(0<M(r.x,r.y,t,i)-s[n].d)return!1}return!0},Y.prototype.getNumVerts=function(){return this.verts.length/2},Y.prototype.getVert=function(t){return new S(this.verts[2*t],this.verts[2*t+1])};var Z=r.Body=function(t,i){this.p=new S(0,0),this.vx=this.vy=0,this.f=new S(0,0),this.w=0,this.t=0,this.v_limit=1/0,this.w_limit=1/0,this.v_biasx=this.v_biasy=0,this.w_bias=0,this.space=null,this.shapeList=[],this.arbiterList=null,this.constraintList=null,this.nodeRoot=null,this.nodeNext=null,this.nodeIdleTime=0,this.setMass(t),this.setMoment(i),this.rot=new S(0,0),this.setAngle(0)};if("undefined"!=typeof DEBUG&&DEBUG){var $=function(t,i){!function(t,i){v(t.x==t.x&&t.y==t.y,i)}(t,i),function(t,i){v(Math.abs(t.x)!==1/0&&Math.abs(t.y)!==1/0,i)}(t,i)};Z.prototype.sanityCheck=function(){v(this.m==this.m&&this.m_inv==this.m_inv,"Body's mass is invalid."),v(this.i==this.i&&this.i_inv==this.i_inv,"Body's moment is invalid."),$(this.p,"Body's position is invalid."),$(this.f,"Body's force is invalid."),v(this.vx==this.vx&&Math.abs(this.vx)!==1/0,"Body's velocity is invalid."),v(this.vy==this.vy&&Math.abs(this.vy)!==1/0,"Body's velocity is invalid."),v(this.a==this.a&&Math.abs(this.a)!==1/0,"Body's angle is invalid."),v(this.w==this.w&&Math.abs(this.w)!==1/0,"Body's angular velocity is invalid."),v(this.t==this.t&&Math.abs(this.t)!==1/0,"Body's torque is invalid."),$(this.rot,"Body's rotation vector is invalid."),v(this.v_limit==this.v_limit,"Body's velocity limit is invalid."),v(this.w_limit==this.w_limit,"Body's angular velocity limit is invalid.")}}else Z.prototype.sanityCheck=function(){};Z.prototype.getPos=function(){return this.p},Z.prototype.getVel=function(){return new S(this.vx,this.vy)},Z.prototype.getAngVel=function(){return this.w},Z.prototype.isSleeping=function(){return null!==this.nodeRoot},Z.prototype.isStatic=function(){return this.nodeIdleTime===1/0},Z.prototype.isRogue=function(){return null===this.space},Z.prototype.setMass=function(t){v(0<t,"Mass must be positive and non-zero."),this.activate(),this.m=t,this.m_inv=1/t},Z.prototype.setMoment=function(t){v(0<t,"Moment of Inertia must be positive and non-zero."),this.activate(),this.i=t,this.i_inv=1/t},Z.prototype.addShape=function(t){this.shapeList.push(t)},Z.prototype.removeShape=function(t){o(this.shapeList,t)};var tt=function(t,i,e){return t===e?t.next(i):(t.a===i?t.next_a=tt(t.next_a,i,e):t.next_b=tt(t.next_b,i,e),t)};Z.prototype.removeConstraint=function(t){this.constraintList=tt(this.constraintList,this,t)},Z.prototype.setPos=function(t){this.activate(),this.sanityCheck(),t===j&&(t=r.v(0,0)),this.p=t},Z.prototype.setVel=function(t){this.activate(),this.vx=t.x,this.vy=t.y},Z.prototype.setAngVel=function(t){this.activate(),this.w=t},Z.prototype.setAngleInternal=function(t){v(!isNaN(t),"Internal Error: Attempting to set body's angle to NaN"),this.a=t,this.rot.x=Math.cos(t),this.rot.y=Math.sin(t)},Z.prototype.setAngle=function(t){this.activate(),this.sanityCheck(),this.setAngleInternal(t)},Z.prototype.velocity_func=function(t,i,e){var s=this.vx*i+(t.x+this.f.x*this.m_inv)*e,n=this.vy*i+(t.y+this.f.y*this.m_inv)*e,r=this.v_limit,o=s*s+n*n,a=r*r<o?r/Math.sqrt(o):1;this.vx=s*a,this.vy=n*a;var h=this.w_limit;this.w=C(this.w*i+this.t*this.i_inv*e,-h,h),this.sanityCheck()},Z.prototype.position_func=function(t){this.p.x+=(this.vx+this.v_biasx)*t,this.p.y+=(this.vy+this.v_biasy)*t,this.setAngleInternal(this.a+(this.w+this.w_bias)*t),this.v_biasx=this.v_biasy=0,this.w_bias=0,this.sanityCheck()},Z.prototype.resetForces=function(){this.activate(),this.f=new S(0,0),this.t=0},Z.prototype.applyForce=function(t,i){this.activate(),this.f=I(this.f,t),this.t+=N(i,t)},Z.prototype.applyImpulse=function(t,i){this.activate(),Ht(this,t.x,t.y,i)},Z.prototype.getVelAtPoint=function(t){return I(new S(this.vx,this.vy),L(p(t),this.w))},Z.prototype.getVelAtWorldPoint=function(t){return this.getVelAtPoint(x(t,this.p))},Z.prototype.getVelAtLocalPoint=function(t){return this.getVelAtPoint(c(t,this.rot))},Z.prototype.eachShape=function(t){for(var i=0,e=this.shapeList.length;i<e;i++)t(this.shapeList[i])},Z.prototype.eachConstraint=function(t){for(var i=this.constraintList;i;){var e=i.next(this);t(i),i=e}},Z.prototype.eachArbiter=function(t){for(var i=this.arbiterList;i;){var e=i.next(this);i.swappedColl=this===i.body_b,t(i),i=e}},Z.prototype.local2World=function(t){return I(this.p,c(t,this.rot))},Z.prototype.world2Local=function(t){return i(x(t,this.p),this.rot)},Z.prototype.kineticEnergy=function(){var t=this.vx*this.vx+this.vy*this.vy,i=this.w*this.w;return(t?t*this.m:0)+(i?i*this.i:0)};var it=r.SpatialIndex=function(t){if(this.staticIndex=t){if(t.dynamicIndex)throw new Error("This static index is already associated with a dynamic index.");t.dynamicIndex=this}};it.prototype.collideStatic=function(t,e){0<t.count&&this.each(function(i){t.query(new q(i.bb_l,i.bb_b,i.bb_r,i.bb_t),function(t){e(i,t)})})};var et=r.BBTree=function(t){it.call(this,t),this.velocityFunc=null,this.leaves={},this.count=0,this.root=null,this.pooledNodes=null,this.pooledPairs=null,this.stamp=0};et.prototype=Object.create(it.prototype);var st=function(t,i,e){this.obj=null,this.bb_l=A(i.bb_l,e.bb_l),this.bb_b=A(i.bb_b,e.bb_b),this.bb_r=B(i.bb_r,e.bb_r),this.bb_t=B(i.bb_t,e.bb_t),this.parent=null,this.setA(i),this.setB(e)};et.prototype.makeNode=function(t,i){var e=this.pooledNodes;return e?(this.pooledNodes=e.parent,e.constructor(this,t,i),e):(0,new st(this,t,i))};var nt=function(t,i){this.obj=i,t.getBB(i,this),this.parent=null,this.stamp=1,this.pairs=null,0};et.prototype.getBB=function(t,i){var e=this.velocityFunc;if(e){var s=.1*(t.bb_r-t.bb_l),n=.1*(t.bb_t-t.bb_b),r=L(e(t),.1);i.bb_l=t.bb_l+A(-s,r.x),i.bb_b=t.bb_b+A(-n,r.y),i.bb_r=t.bb_r+B(s,r.x),i.bb_t=t.bb_t+B(n,r.y)}else i.bb_l=t.bb_l,i.bb_b=t.bb_b,i.bb_r=t.bb_r,i.bb_t=t.bb_t},et.prototype.getStamp=function(){var t=this.dynamicIndex;return t&&t.stamp?t.stamp:this.stamp},et.prototype.incrementStamp=function(){this.dynamicIndex&&this.dynamicIndex.stamp?this.dynamicIndex.stamp++:this.stamp++};var rt=function(t,i,e,s){this.prevA=null,this.leafA=t,this.nextA=i,this.prevB=null,this.leafB=e,this.nextB=s};et.prototype.makePair=function(t,i,e,s){var n=this.pooledPairs;return n?(this.pooledPairs=n.prevA,n.prevA=null,n.leafA=t,n.nextA=i,n.prevB=null,n.leafB=e,n.nextB=s,n):(0,new rt(t,i,e,s))},rt.prototype.recycle=function(t){this.prevA=t.pooledPairs,t.pooledPairs=this};var ot=function(t,i,e){e&&(e.leafA===i?e.prevA=t:e.prevB=t),t?t.leafA===i?t.nextA=e:t.nextB=e:i.pairs=e};nt.prototype.clearPairs=function(t){var i,e=this.pairs;for(this.pairs=null;e;)e.leafA===this?(i=e.nextA,ot(e.prevB,e.leafB,e.nextB)):(i=e.nextB,ot(e.prevA,e.leafA,e.nextA)),e.recycle(t),e=i};var at=function(t,i,e){var s=t.pairs,n=i.pairs,r=e.makePair(t,s,i,n);t.pairs=i.pairs=r,s&&(s.leafA===t?s.prevA=r:s.prevB=r),n&&(n.leafA===i?n.prevA=r:n.prevB=r)};st.prototype.recycle=function(t){this.parent=t.pooledNodes,t.pooledNodes=this},nt.prototype.recycle=function(t){},st.prototype.setA=function(t){(this.A=t).parent=this},st.prototype.setB=function(t){(this.B=t).parent=this},st.prototype.isLeaf=!(nt.prototype.isLeaf=!0),st.prototype.otherChild=function(t){return this.A==t?this.B:this.A},st.prototype.replaceChild=function(t,i,e){g(t==this.A||t==this.B,"Node is not a child of parent."),this.A==t?(this.A.recycle(e),this.setA(i)):(this.B.recycle(e),this.setB(i));for(var s=this;s;s=s.parent){var n=s.A,r=s.B;s.bb_l=A(n.bb_l,r.bb_l),s.bb_b=A(n.bb_b,r.bb_b),s.bb_r=B(n.bb_r,r.bb_r),s.bb_t=B(n.bb_t,r.bb_t)}},st.prototype.bbArea=nt.prototype.bbArea=function(){return(this.bb_r-this.bb_l)*(this.bb_t-this.bb_b)};var ht=function(t,i){return(B(t.bb_r,i.bb_r)-A(t.bb_l,i.bb_l))*(B(t.bb_t,i.bb_t)-A(t.bb_b,i.bb_b))},ct=function(t,i){return Math.abs(t.bb_l+t.bb_r-i.bb_l-i.bb_r)+Math.abs(t.bb_b+t.bb_t-i.bb_b-i.bb_t)},pt=function(t,i,e){if(null==t)return i;if(t.isLeaf)return e.makeNode(i,t);var s=t.B.bbArea()+ht(t.A,i),n=t.A.bbArea()+ht(t.B,i);return s===n&&(s=ct(t.A,i),n=ct(t.B,i)),n<s?t.setB(pt(t.B,i,e)):t.setA(pt(t.A,i,e)),t.bb_l=A(t.bb_l,i.bb_l),t.bb_b=A(t.bb_b,i.bb_b),t.bb_r=B(t.bb_r,i.bb_r),t.bb_t=B(t.bb_t,i.bb_t),t};st.prototype.intersectsBB=nt.prototype.intersectsBB=function(t){return this.bb_l<=t.r&&t.l<=this.bb_r&&this.bb_b<=t.t&&t.b<=this.bb_t};var ut=function(t,i,e){t.intersectsBB(i)&&(t.isLeaf?e(t.obj):(ut(t.A,i,e),ut(t.B,i,e)))},lt=function(t,i,e){var s=1/(e.x-i.x),n=t.bb_l==i.x?-1/0:(t.bb_l-i.x)*s,r=t.bb_r==i.x?1/0:(t.bb_r-i.x)*s,o=A(n,r),a=B(n,r),h=1/(e.y-i.y),c=t.bb_b==i.y?-1/0:(t.bb_b-i.y)*h,p=t.bb_t==i.y?1/0:(t.bb_t-i.y)*h,u=A(c,p),l=B(c,p);if(u<=a&&o<=l){var b=B(o,u);if(0<=A(a,l)&&b<=1)return B(b,0)}return 1/0},bt=function(t,i,e,s,n){if(t.isLeaf)return n(t.obj);var r=lt(t.A,i,e),o=lt(t.B,i,e);return r<o?(r<s&&(s=A(s,bt(t.A,i,e,s,n))),o<s&&(s=A(s,bt(t.B,i,e,s,n)))):(o<s&&(s=A(s,bt(t.B,i,e,s,n))),r<s&&(s=A(s,bt(t.A,i,e,s,n)))),s};et.prototype.subtreeRecycle=function(t){t.isLeaf&&(this.subtreeRecycle(t.A),this.subtreeRecycle(t.B),t.recycle(this))};var yt=function(t,i,e){if(i==t)return null;var s=i.parent;if(s!=t)return s.parent.replaceChild(s,s.otherChild(i),e),t;var n=t.otherChild(i);return n.parent=t.parent,t.recycle(e),n},vt=function(t,i){return t.bb_l<=i.bb_r&&i.bb_l<=t.bb_r&&t.bb_b<=i.bb_t&&i.bb_b<=t.bb_t};nt.prototype.markLeafQuery=function(t,i,e,s){vt(t,this)&&(i?at(t,this,e):(this.stamp<t.stamp&&at(this,t,e),s&&s(t.obj,this.obj)))},st.prototype.markLeafQuery=function(t,i,e,s){vt(t,this)&&(this.A.markLeafQuery(t,i,e,s),this.B.markLeafQuery(t,i,e,s))},nt.prototype.markSubtree=function(t,i,e){if(this.stamp==t.getStamp()){i&&i.markLeafQuery(this,!1,t,e);for(var s=this;s.parent;s=s.parent)s==s.parent.A?s.parent.B.markLeafQuery(this,!0,t,e):s.parent.A.markLeafQuery(this,!1,t,e)}else for(var n=this.pairs;n;)n=this===n.leafB?(e&&e(n.leafA.obj,this.obj),n.nextB):n.nextA},st.prototype.markSubtree=function(t,i,e){this.A.markSubtree(t,i,e),this.B.markSubtree(t,i,e)},nt.prototype.containsObj=function(t){return this.bb_l<=t.bb_l&&this.bb_r>=t.bb_r&&this.bb_b<=t.bb_b&&this.bb_t>=t.bb_t},nt.prototype.update=function(t){var i=t.root,e=this.obj;return!this.containsObj(e)&&(t.getBB(this.obj,this),i=yt(i,this,t),t.root=pt(i,this,t),this.clearPairs(t),this.stamp=t.getStamp(),!0)},nt.prototype.addPairs=function(t){var i=t.dynamicIndex;if(i){var e=i.root;e&&e.markLeafQuery(this,!0,i,null)}else{var s=t.staticIndex.root;this.markSubtree(t,s,null)}},et.prototype.insert=function(t,i){var e=new nt(this,t);this.leaves[i]=e,this.root=pt(this.root,e,this),this.count++,e.stamp=this.getStamp(),e.addPairs(this),this.incrementStamp()},et.prototype.remove=function(t,i){var e=this.leaves[i];delete this.leaves[i],this.root=yt(this.root,e,this),this.count--,e.clearPairs(this),e.recycle(this)},et.prototype.contains=function(t,i){return null!=this.leaves[i]};var ft=function(t,i){};et.prototype.reindexQuery=function(t){if(this.root){var i,e=this.leaves;for(i in e)e[i].update(this);var s=this.staticIndex,n=s&&s.root;this.root.markSubtree(this,n,t),s&&!n&&this.collideStatic(s,t),this.incrementStamp()}},et.prototype.reindex=function(){this.reindexQuery(ft)},et.prototype.reindexObject=function(t,i){var e=this.leaves[i];e&&(e.update(this)&&e.addPairs(this),this.incrementStamp())},et.prototype.pointQuery=function(t,i){this.query(new q(t.x,t.y,t.x,t.y),i)},et.prototype.segmentQuery=function(t,i,e,s){this.root&&bt(this.root,t,i,e,s)},et.prototype.query=function(t,i){this.root&&ut(this.root,t,i)},et.prototype.count=function(){return this.count},et.prototype.each=function(t){var i;for(i in this.leaves)t(this.leaves[i].obj)};var dt=function(t,i,e,s,n){return(B(t.bb_r,s)-A(t.bb_l,i))*(B(t.bb_t,n)-A(t.bb_b,e))},_t=function(t,i,e,s){if(1==s)return i[e];if(2==s)return t.makeNode(i[e],i[e+1]);for(var n=(S=i[e]).bb_l,r=S.bb_b,o=S.bb_r,a=S.bb_t,h=e+s,c=e+1;c<h;c++)S=i[c],n=A(n,S.bb_l),r=A(r,S.bb_b),o=B(o,S.bb_r),a=B(a,S.bb_t);var p=a-r<o-n,u=new Array(2*s);if(p)for(c=e;c<h;c++)u[2*c+0]=i[c].bb_l,u[2*c+1]=i[c].bb_r;else for(c=e;c<h;c++)u[2*c+0]=i[c].bb_b,u[2*c+1]=i[c].bb_t;u.sort(function(t,i){return t-i});var l=.5*(u[s-1]+u[s]),b=n,y=r,v=o,f=a,d=n,_=r,x=o,m=a;p?v=d=l:f=_=l;for(var g=h,w=e;w<g;){var S=i[w];dt(S,d,_,x,m)<dt(S,b,y,v,f)?(g--,i[w]=i[g],i[g]=S):w++}if(g!=s)return NodeNew(t,_t(t,i,e,g-e),_t(t,i,g,h-g));for(S=null,c=e;c<h;c++)S=pt(S,i[c],t);return S};et.prototype.optimize=function(){var t=new Array(this.count),i=0;for(var e in this.leaves)t[i++]=this.nodes[e];tree.subtreeRecycle(root),this.root=_t(tree,t,t.length)};var xt=function(t,i){!t.isLeaf&&i<=10&&(xt(t.A,i+1),xt(t.B,i+1));for(var e="",s=0;s<i;s++)e+=" ";console.log(e+t.bb_b+" "+t.bb_t)};et.prototype.log=function(){this.root&&xt(this.root,0)};var mt=r.CollisionHandler=function(){this.a=this.b=0};mt.prototype.begin=function(t,i){return!0},mt.prototype.preSolve=function(t,i){return!0},mt.prototype.postSolve=function(t,i){},mt.prototype.separate=function(t,i){};var gt=function(t,i){this.e=0,this.u=0,this.surface_vr=j,this.a=t,this.body_a=t.body,this.b=i,this.body_b=i.body,this.thread_a_next=this.thread_a_prev=null,this.thread_b_next=this.thread_b_prev=null,this.contacts=null,this.stamp=0,this.handler=null,this.swappedColl=!1,this.state="first coll"};gt.prototype.getShapes=function(){return this.swappedColl?[this.b,this.a]:[this.a,this.b]},gt.prototype.totalImpulse=function(){for(var t=this.contacts,i=new S(0,0),e=0,s=t.length;e<s;e++){var n=t[e];i.add(L(n.n,n.jnAcc))}return this.swappedColl?i:i.neg()},gt.prototype.totalImpulseWithFriction=function(){for(var t=this.contacts,i=new S(0,0),e=0,s=t.length;e<s;e++){var n=t[e];i.add(new S(n.jnAcc,n.jtAcc).rotate(n.n))}return this.swappedColl?i:i.neg()},gt.prototype.totalKE=function(){for(var t=(1-this.e)/(1+this.e),i=0,e=this.contacts,s=0,n=e.length;s<n;s++){var r=e[s],o=r.jnAcc,a=r.jtAcc;i+=t*o*o/r.nMass+a*a/r.tMass}return i},gt.prototype.ignore=function(){this.state="ignore"},gt.prototype.getA=function(){return this.swappedColl?this.b:this.a},gt.prototype.getB=function(){return this.swappedColl?this.a:this.b},gt.prototype.isFirstContact=function(){return"first coll"===this.state};var wt=function(t,i,e){this.point=t,this.normal=i,this.dist=e};gt.prototype.getContactPointSet=function(){var t,i=new Array(this.contacts.length);for(t=0;t<i.length;t++)i[t]=new wt(this.contacts[t].p,this.contacts[t].n,this.contacts[t].dist);return i},gt.prototype.getNormal=function(t){var i=this.contacts[t].n;return this.swappedColl?P(i):i},gt.prototype.getPoint=function(t){return this.contacts[t].p},gt.prototype.getDepth=function(t){return this.contacts[t].dist};var St=function(t,i,e,s){e?e.body_a===i?e.thread_a_next=s:e.thread_b_next=s:i.arbiterList===t&&(i.arbiterList=s),s&&(s.body_a===i?s.thread_a_prev=e:s.thread_b_prev=e)};gt.prototype.unthread=function(){St(this,this.body_a,this.thread_a_prev,this.thread_a_next),St(this,this.body_b,this.thread_b_prev,this.thread_b_next),this.thread_a_prev=this.thread_a_next=null,this.thread_b_prev=this.thread_b_next=null},gt.prototype.update=function(t,i,e,s){if(this.contacts)for(var n=0;n<this.contacts.length;n++)for(var r=this.contacts[n],o=0;o<t.length;o++){var a=t[o];a.hash===r.hash&&(a.jnAcc=r.jnAcc,a.jtAcc=r.jtAcc)}this.contacts=t,this.handler=i,this.swappedColl=e.collision_type!==i.a,this.e=e.e*s.e,this.u=e.u*s.u,this.surface_vr=x(e.surface_v,s.surface_v),this.a=e,this.body_a=e.body,this.b=s,this.body_b=s.body,"cached"==this.state&&(this.state="first coll")},gt.prototype.preStep=function(t,i,e){for(var s=this.body_a,n=this.body_b,r=0;r<this.contacts.length;r++){var o=this.contacts[r];o.r1=x(o.p,s.p),o.r2=x(o.p,n.p),o.nMass=1/zt(s,n,o.r1,o.r2,o.n),o.tMass=1/zt(s,n,o.r1,o.r2,p(o.n)),o.bias=-e*A(0,o.dist+i)/t,o.jBias=0,o.bounce=Et(s,n,o.r1,o.r2,o.n)*this.e}},gt.prototype.applyCachedImpulse=function(t){if(!this.isFirstContact())for(var i=this.body_a,e=this.body_b,s=0;s<this.contacts.length;s++){var n=this.contacts[s],r=n.n.x,o=n.n.y,a=r*n.jnAcc-o*n.jtAcc,h=r*n.jtAcc+o*n.jnAcc;Dt(i,e,n.r1,n.r2,a*t,h*t)}};gt.prototype.applyImpulse=function(){0;for(var t=this.body_a,i=this.body_b,e=this.surface_vr,s=this.u,n=0;n<this.contacts.length;n++){0;var r=this.contacts[n],o=r.nMass,a=r.n,h=r.r1,c=r.r2,p=i.vx-c.y*i.w-(t.vx-h.y*t.w),u=i.vy+c.x*i.w-(t.vy+h.x*t.w),l=a.x*(i.v_biasx-c.y*i.w_bias-t.v_biasx+h.y*t.w_bias)+a.y*(c.x*i.w_bias+i.v_biasy-h.x*t.w_bias-t.v_biasy),b=M(p,u,a.x,a.y),y=M(p+e.x,u+e.y,-a.y,a.x),v=(r.bias-l)*o,f=r.jBias;r.jBias=B(f+v,0);var d=-(r.bounce+b)*o,_=r.jnAcc;r.jnAcc=B(_+d,0);var x=s*r.jnAcc,m=-y*r.tMass,g=r.jtAcc;r.jtAcc=C(g+m,-x,x);var w=a.x*(r.jBias-f),S=a.y*(r.jBias-f);Gt(t,-w,-S,h),Gt(i,w,S,c);var A=r.jnAcc-_,j=r.jtAcc-g;Dt(t,i,h,c,a.x*A-a.y*j,a.x*j+a.y*A)}},gt.prototype.callSeparate=function(t){t.lookupHandler(this.a.collision_type,this.b.collision_type).separate(this,t)},gt.prototype.next=function(t){return this.body_a==t?this.thread_a_next:this.thread_b_next};var At=function(t,i,e,s){this.p=t,this.n=i,this.dist=e,this.r1=this.r2=j,this.nMass=this.tMass=this.bounce=this.bias=0,this.jnAcc=this.jtAcc=this.jBias=0,this.hash=s,0},jt=[],Bt=function(t,i,e,s){var n=e+s,r=x(i,t),o=Q(r);if(!(n*n<=o)){var a=Math.sqrt(o);return new At(I(t,L(r,.5+(e-.5*n)/(a||1/0))),a?L(r,1/a):new S(1,0),a-n,0)}},Ct=0,kt=function(t,i){var e=0,s=t.valueOnAxis(i[0].n,i[0].d);if(0<s)return-1;for(var n=1;n<i.length;n++){var r=t.valueOnAxis(i[n].n,i[n].d);if(0<r)return-1;s<r&&(s=r,e=n)}return Ct=s,e},Mt=function(t,i,e,s){for(var n=[],r=t.tVerts,o=0;o<r.length;o+=2){var a=r[o],h=r[o+1];i.containsVert(a,h)&&n.push(new At(new S(a,h),e,s,w(t.hashid,o>>1)))}var c=i.tVerts;for(o=0;o<c.length;o+=2){a=c[o],h=c[o+1];t.containsVert(a,h)&&n.push(new At(new S(a,h),e,s,w(i.hashid,o>>1)))}return n.length?n:function(t,i,e,s){for(var n=[],r=t.tVerts,o=0;o<r.length;o+=2){var a=r[o],h=r[o+1];i.containsVertPartial(a,h,P(e))&&n.push(new At(new S(a,h),e,s,w(t.hashid,o)))}var c=i.tVerts;for(o=0;o<c.length;o+=2)a=c[o],h=c[o+1],t.containsVertPartial(a,h,e)&&n.push(new At(new S(a,h),e,s,w(i.hashid,o)));return n}(t,i,e,s)},It=function(t,i,e){var s=k(i,t.ta)-t.r,n=k(i,t.tb)-t.r;return A(s,n)-e},Pt=function(t,i,e,s,n){for(var r=N(i.tn,i.ta),o=N(i.tn,i.tb),a=L(i.tn,n),h=e.tVerts,c=0;c<h.length;c+=2){var p=h[c],u=h[c+1];if(M(p,u,a.x,a.y)<k(i.tn,i.ta)*n+i.r){var l=F(i.tn.x,i.tn.y,p,u);l<=r&&o<=l&&t.push(new At(new S(p,u),a,s,w(e.hashid,c)))}}};t.prototype.collisionCode=0,J.prototype.collisionCode=1,Y.prototype.collisionCode=2,t.prototype.collisionTable=[function(t,i){var e=Bt(t.tc,i.tc,t.r,i.r);return e?[e]:jt},function(t,i){var e=i.ta,s=i.tb,n=t.tc,r=x(s,e),o=m(k(r,x(n,e))/Q(r)),a=I(e,L(r,o)),h=Bt(n,a,t.r,i.r);if(h){var c=h.n;return 0===o&&k(c,i.a_tangent)<0||1===o&&k(c,i.b_tangent)<0?jt:[h]}return jt},function(t,i){for(var e=i.tPlanes,s=0,n=k(e[0].n,t.tc)-e[0].d-t.r,r=0;r<e.length;r++){var o=k(e[r].n,t.tc)-e[r].d-t.r;if(0<o)return jt;n<o&&(n=o,s=r)}var a,h=e[s].n,c=i.tVerts,p=c.length,u=s<<1,l=c[u],b=c[1+u],y=c[(2+u)%p],v=c[(3+u)%p],f=F(h.x,h.y,l,b),d=F(h.x,h.y,y,v),_=N(h,t.tc);return _<d?(a=Bt(t.tc,new S(y,v),t.r,0))?[a]:jt:_<f?[new At(x(t.tc,L(h,t.r+n/2)),P(h),n,0)]:(a=Bt(t.tc,new S(l,b),t.r,0))?[a]:jt}],J.prototype.collisionTable=[null,function(t,i){return jt},function(t,i){var e=[],s=i.tPlanes,n=s.length,r=k(t.tn,t.ta),o=i.valueOnAxis(t.tn,r)-t.r,a=i.valueOnAxis(P(t.tn),-r)-t.r;if(0<a||0<o)return jt;var h=0,c=It(t,s[0].n,s[0].d);if(0<c)return jt;for(var p=0;p<n;p++){var u=It(t,s[p].n,s[p].d);if(0<u)return jt;c<u&&(c=u,h=p)}var l=P(s[h].n),b=I(t.ta,L(l,t.r)),y=I(t.tb,L(l,t.r));if(i.containsVert(b.x,b.y)&&e.push(new At(b,l,c,w(t.hashid,0))),i.containsVert(y.x,y.y)&&e.push(new At(y,l,c,w(t.hashid,1))),(c<=o||c<=a)&&(a<o?Pt(e,t,i,o,1):Pt(e,t,i,a,-1)),0===e.length){var v,f=2*h,d=i.tVerts,_=new S(d[f],d[1+f]);if(v=Bt(t.ta,_,t.r,0))return[v];if(v=Bt(t.tb,_,t.r,0))return[v];var x=2*n,m=new S(d[(2+f)%x],d[(3+f)%x]);if(v=Bt(t.ta,m,t.r,0))return[v];if(v=Bt(t.tb,m,t.r,0))return[v]}return e}],Y.prototype.collisionTable=[null,null,function(t,i){var e=kt(i,t.tPlanes);if(-1==e)return jt;var s=Ct,n=kt(t,i.tPlanes);if(-1==n)return jt;var r=Ct;return r<s?Mt(t,i,t.tPlanes[e].n,s):Mt(t,i,P(i.tPlanes[n].n),r)}];var Lt=r.collideShapes=function(t,i){return v(t.collisionCode<=i.collisionCode,"Collided shapes must be sorted by type"),t.collisionTable[i.collisionCode](t,i)},Nt=new mt,Ft=r.Space=function(){this.stamp=0,this.curr_dt=0,this.bodies=[],this.rousedBodies=[],this.sleepingComponents=[],this.staticShapes=new et(null),this.activeShapes=new et(this.staticShapes),this.arbiters=[],this.contactBuffersHead=null,this.cachedArbiters={},this.constraints=[],this.locked=0,this.collisionHandlers={},this.defaultHandler=Nt,this.postStepCallbacks=[],this.iterations=10,this.gravity=j,this.damping=1,this.idleSpeedThreshold=0,this.sleepTimeThreshold=1/0,this.collisionSlop=.1,this.collisionBias=Math.pow(.9,60),this.collisionPersistence=3,this.enableContactGraph=!1,this.staticBody=new Z(1/0,1/0),this.staticBody.nodeIdleTime=1/0,this.collideShapes=this.makeCollideShapes()};Ft.prototype.getCurrentTimeStep=function(){return this.curr_dt},Ft.prototype.setIterations=function(t){this.iterations=t},Ft.prototype.isLocked=function(){return this.locked};var Qt=function(t){v(!t.locked,"This addition/removal cannot be done safely during a call to cpSpaceStep()  or during a query. Put these calls into a post-step callback.")};Ft.prototype.addCollisionHandler=function(t,i,e,s,n,r){Qt(this),this.removeCollisionHandler(t,i);var o=new mt;o.a=t,o.b=i,e&&(o.begin=e),s&&(o.preSolve=s),n&&(o.postSolve=n),r&&(o.separate=r),this.collisionHandlers[w(t,i)]=o},Ft.prototype.removeCollisionHandler=function(t,i){Qt(this),delete this.collisionHandlers[w(t,i)]},Ft.prototype.setDefaultCollisionHandler=function(t,i,e,s){Qt(this);var n=new mt;t&&(n.begin=t),i&&(n.preSolve=i),e&&(n.postSolve=e),s&&(n.separate=s),this.defaultHandler=n},Ft.prototype.lookupHandler=function(t,i){return this.collisionHandlers[w(t,i)]||this.defaultHandler},Ft.prototype.addShape=function(t){var i=t.body;return i.isStatic()?this.addStaticShape(t):(v(!t.space,"This shape is already added to a space and cannot be added to another."),Qt(this),i.activate(),i.addShape(t),t.update(i.p,i.rot),this.activeShapes.insert(t,t.hashid),t.space=this,t)},Ft.prototype.addStaticShape=function(t){v(!t.space,"This shape is already added to a space and cannot be added to another."),Qt(this);var i=t.body;return i.addShape(t),t.update(i.p,i.rot),this.staticShapes.insert(t,t.hashid),t.space=this,t},Ft.prototype.addBody=function(t){return v(!t.isStatic(),"Static bodies cannot be added to a space as they are not meant to be simulated."),v(!t.space,"This body is already added to a space and cannot be added to another."),Qt(this),this.bodies.push(t),t.space=this,t},Ft.prototype.addConstraint=function(t){v(!t.space,"This shape is already added to a space and cannot be added to another."),Qt(this);var i=t.a,e=t.b;return i.activate(),e.activate(),this.constraints.push(t),t.next_a=i.constraintList,(i.constraintList=t).next_b=e.constraintList,(e.constraintList=t).space=this,t},Ft.prototype.filterArbiters=function(t,i){for(var e in this.cachedArbiters){var s=this.cachedArbiters[e];(t!==s.body_a||i!==s.a&&null!==i)&&(t!==s.body_b||i!==s.b&&null!==i)||(i&&"cached"!==s.state&&s.callSeparate(this),s.unthread(),o(this.arbiters,s),delete this.cachedArbiters[e])}},Ft.prototype.removeShape=function(t){var i=t.body;i.isStatic()?this.removeStaticShape(t):(v(this.containsShape(t),"Cannot remove a shape that was not added to the space. (Removed twice maybe?)"),Qt(this),i.activate(),i.removeShape(t),this.filterArbiters(i,t),this.activeShapes.remove(t,t.hashid),t.space=null)},Ft.prototype.removeStaticShape=function(t){v(this.containsShape(t),"Cannot remove a static or sleeping shape that was not added to the space. (Removed twice maybe?)"),Qt(this);var i=t.body;i.isStatic()&&i.activateStatic(t),i.removeShape(t),this.filterArbiters(i,t),this.staticShapes.remove(t,t.hashid),t.space=null},Ft.prototype.removeBody=function(t){v(this.containsBody(t),"Cannot remove a body that was not added to the space. (Removed twice maybe?)"),Qt(this),t.activate(),o(this.bodies,t),t.space=null},Ft.prototype.removeConstraint=function(t){v(this.containsConstraint(t),"Cannot remove a constraint that was not added to the space. (Removed twice maybe?)"),Qt(this),t.a.activate(),t.b.activate(),o(this.constraints,t),t.a.removeConstraint(t),t.b.removeConstraint(t),t.space=null},Ft.prototype.containsShape=function(t){return t.space===this},Ft.prototype.containsBody=function(t){return t.space==this},Ft.prototype.containsConstraint=function(t){return t.space==this},Ft.prototype.uncacheArbiter=function(t){delete this.cachedArbiters[w(t.a.hashid,t.b.hashid)],o(this.arbiters,t)},Ft.prototype.eachBody=function(t){this.lock();for(var i=this.bodies,e=0;e<i.length;e++)t(i[e]);var s=this.sleepingComponents;for(e=0;e<s.length;e++)for(var n=s[e];n;){var r=n.nodeNext;t(n),n=r}this.unlock(!0)},Ft.prototype.eachShape=function(t){this.lock(),this.activeShapes.each(t),this.staticShapes.each(t),this.unlock(!0)},Ft.prototype.eachConstraint=function(t){this.lock();for(var i=this.constraints,e=0;e<i.length;e++)t(i[e]);this.unlock(!0)},Ft.prototype.reindexStatic=function(){v(!this.locked,"You cannot manually reindex objects while the space is locked. Wait until the current query or step is complete."),this.staticShapes.each(function(t){var i=t.body;t.update(i.p,i.rot)}),this.staticShapes.reindex()},Ft.prototype.reindexShape=function(t){v(!this.locked,"You cannot manually reindex objects while the space is locked. Wait until the current query or step is complete.");var i=t.body;t.update(i.p,i.rot),this.activeShapes.reindexObject(t,t.hashid),this.staticShapes.reindexObject(t,t.hashid)},Ft.prototype.reindexShapesForBody=function(t){for(var i=t.shapeList;i;i=i.next)this.reindexShape(i)},Ft.prototype.useSpatialHash=function(t,i){throw new Error("Spatial Hash not implemented.")},Ft.prototype.activateBody=function(t){if(v(!t.isRogue(),"Internal error: Attempting to activate a rogue body."),this.locked)-1===this.rousedBodies.indexOf(t)&&this.rousedBodies.push(t);else{this.bodies.push(t);for(var i=0;i<t.shapeList.length;i++){var e=t.shapeList[i];this.staticShapes.remove(e,e.hashid),this.activeShapes.insert(e,e.hashid)}for(var s=t.arbiterList;s;s=s.next(t)){if(t===(a=s.body_a)||a.isStatic()){var n=s.a,r=s.b;(this.cachedArbiters[w(n.hashid,r.hashid)]=s).stamp=this.stamp,s.handler=this.lookupHandler(n.collision_type,r.collision_type),this.arbiters.push(s)}}for(var o=t.constraintList;o;o=o.nodeNext){var a;(t===(a=o.a)||a.isStatic())&&this.constraints.push(o)}}},Ft.prototype.deactivateBody=function(t){v(!t.isRogue(),"Internal error: Attempting to deactivate a rogue body."),o(this.bodies,t);for(var i=0;i<t.shapeList.length;i++){var e=t.shapeList[i];this.activeShapes.remove(e,e.hashid),this.staticShapes.insert(e,e.hashid)}for(var s=t.arbiterList;s;s=s.next(t)){(t===(r=s.body_a)||r.isStatic())&&this.uncacheArbiter(s)}for(var n=t.constraintList;n;n=n.nodeNext){var r;(t===(r=n.a)||r.isStatic())&&o(this.constraints,n)}};var Tt=function(t){return t?t.nodeRoot:null};Z.prototype.activate=function(){this.isRogue()||(this.nodeIdleTime=0,function(t){if(t&&t.isSleeping(t)){v(!t.isRogue(),"Internal Error: componentActivate() called on a rogue body.");for(var i=t.space,e=t;e;){var s=e.nodeNext;e.nodeIdleTime=0,e.nodeRoot=null,e.nodeNext=null,i.activateBody(e),e=s}o(i.sleepingComponents,t)}}(Tt(this)))},Z.prototype.activateStatic=function(t){v(this.isStatic(),"Body.activateStatic() called on a non-static body.");for(var i=this.arbiterList;i;i=i.next(this))t&&t!=i.a&&t!=i.b||(i.body_a==this?i.body_b:i.body_a).activate()},Z.prototype.pushArbiter=function(t){g(null===(t.body_a===this?t.thread_a_next:t.thread_b_next),"Internal Error: Dangling contact graph pointers detected. (A)"),g(null===(t.body_a===this?t.thread_a_prev:t.thread_b_prev),"Internal Error: Dangling contact graph pointers detected. (B)");var i=this.arbiterList;g(null===i||null===(i.body_a===this?i.thread_a_prev:i.thread_b_prev),"Internal Error: Dangling contact graph pointers detected. (C)"),t.body_a===this?t.thread_a_next=i:t.thread_b_next=i,i&&(i.body_a===this?i.thread_a_prev=t:i.thread_b_prev=t),this.arbiterList=t};var Rt=function(t,i){if(!i.isRogue()){var e=Tt(i);if(null==e){!function(t,i){i.nodeRoot=t,i!==t&&(i.nodeNext=t.nodeNext,t.nodeNext=i)}(t,i);for(var s=i.arbiterList;s;s=s.next(i))Rt(t,i==s.body_a?s.body_b:s.body_a);for(var n=i.constraintList;n;n=n.next(i))Rt(t,i==n.a?n.b:n.a)}else g(e===t,"Internal Error: Inconsistency detected in the contact graph.")}},Vt=function(t,i){for(var e=t;e;e=e.nodeNext)if(e.nodeIdleTime<i)return!0;return!1};Ft.prototype.processComponents=function(t){for(var i=this.sleepTimeThreshold!==1/0,e=this.bodies,s=0;s<e.length;s++){var n=e[s];g(null===n.nodeNext,"Internal Error: Dangling next pointer detected in contact graph."),g(null===n.nodeRoot,"Internal Error: Dangling root pointer detected in contact graph.")}if(i){var r=this.idleSpeedThreshold,o=r?r*r:Q(this.gravity)*t*t;for(s=0;s<e.length;s++){n=e[s];var a=o?n.m*o:0;n.nodeIdleTime=n.kineticEnergy()>a?0:n.nodeIdleTime+t}}for(var h=this.arbiters,c=(s=0,h.length);s<c;s++){var p=h[s],u=p.body_a,l=p.body_b;i&&((l.isRogue()&&!l.isStatic()||u.isSleeping())&&u.activate(),(u.isRogue()&&!u.isStatic()||l.isSleeping())&&l.activate()),u.pushArbiter(p),l.pushArbiter(p)}if(i){var b=this.constraints;for(s=0;s<b.length;s++){var y=b[s];u=y.a;(l=y.b).isRogue()&&!l.isStatic()&&u.activate(),u.isRogue()&&!u.isStatic()&&l.activate()}for(s=0;s<e.length;){n=e[s];if(null!==Tt(n)||(Rt(n,n),Vt(n,this.sleepTimeThreshold)))s++,n.nodeRoot=null,n.nodeNext=null;else{this.sleepingComponents.push(n);for(var v=n;v;v=v.nodeNext)this.deactivateBody(v)}}}},Z.prototype.sleep=function(){this.sleepWithGroup(null)},Z.prototype.sleepWithGroup=function(t){v(!this.isStatic()&&!this.isRogue(),"Rogue and static bodies cannot be put to sleep.");var i=this.space;if(v(i,"Cannot put a rogue body to sleep."),v(!i.locked,"Bodies cannot be put to sleep during a query or a call to cpSpaceStep(). Put these calls into a post-step callback."),v(null===t||t.isSleeping(),"Cannot use a non-sleeping body as a group identifier."),this.isSleeping())v(Tt(this)===Tt(t),"The body is already sleeping and it's group cannot be reassigned.");else{for(var e=0;e<this.shapeList.length;e++)this.shapeList[e].update(this.p,this.rot);if(i.deactivateBody(this),t){var s=Tt(t);this.nodeRoot=s,this.nodeNext=s.nodeNext,this.nodeIdleTime=0,s.nodeNext=this}else(this.nodeRoot=this).nodeNext=null,this.nodeIdleTime=0,i.sleepingComponents.push(this);o(i.bodies,this)}},Ft.prototype.activateShapesTouchingShape=function(t){this.sleepTimeThreshold!==1/0&&this.shapeQuery(t,function(t,i){t.body.activate()})},Ft.prototype.pointQuery=function(i,e,s,n){var t=function(t){(!t.group||s!==t.group)&&e&t.layers&&t.pointQuery(i)&&n(t)},r=new q(i.x,i.y,i.x,i.y);this.lock(),this.activeShapes.query(r,t),this.staticShapes.query(r,t),this.unlock(!0)},Ft.prototype.pointQueryFirst=function(t,i,e){var s=null;return this.pointQuery(t,i,e,function(t){t.sensor||(s=t)}),s},Ft.prototype.nearestPointQuery=function(e,s,n,r,o){var t=function(t){if((!t.group||r!==t.group)&&n&t.layers){var i=t.nearestPointQuery(e);i.d<s&&o(t,i.d,i.p)}},i=E(e,s);this.lock(),this.activeShapes.query(i,t),this.staticShapes.query(i,t),this.unlock(!0)},Ft.prototype.nearestPointQueryNearest=function(e,s,n,r){var o,t=function(t){if((!t.group||r!==t.group)&&n&t.layers&&!t.sensor){var i=t.nearestPointQuery(e);i.d<s&&(!o||i.d<o.d)&&(o=i)}},i=E(e,s);return this.activeShapes.query(i,t),this.staticShapes.query(i,t),o},Ft.prototype.segmentQuery=function(e,s,n,r,o){var t=function(t){var i;return(!t.group||r!==t.group)&&n&t.layers&&(i=t.segmentQuery(e,s))&&o(t,i.t,i.n),1};this.lock(),this.staticShapes.segmentQuery(e,s,1,t),this.activeShapes.segmentQuery(e,s,1,t),this.unlock(!0)},Ft.prototype.segmentQueryFirst=function(e,s,n,r){var o=null,t=function(t){var i;return(!t.group||r!==t.group)&&n&t.layers&&!t.sensor&&(i=t.segmentQuery(e,s))&&(null===o||i.t<o.t)&&(o=i),o?o.t:1};return this.staticShapes.segmentQuery(e,s,1,t),this.activeShapes.segmentQuery(e,s,o?o.t:1,t),o},Ft.prototype.bbQuery=function(i,e,s,n){var t=function(t){(!t.group||s!==t.group)&&e&t.layers&&function(t,i,e,s,n){return t.l<=s&&i<=t.r&&t.b<=n&&e<=t.t}(i,t.bb_l,t.bb_b,t.bb_r,t.bb_t)&&n(t)};this.lock(),this.activeShapes.query(i,t),this.staticShapes.query(i,t),this.unlock(!0)},Ft.prototype.shapeQuery=function(r,o){var t=r.body;t&&r.update(t.p,t.rot);var i=new q(r.bb_l,r.bb_b,r.bb_r,r.bb_t),a=!1,e=function(t){var i=r;if((!i.group||i.group!==t.group)&&i.layers&t.layers&&i!==t){var e;if(i.collisionCode<=t.collisionCode)e=Lt(i,t);else{e=Lt(t,i);for(var s=0;s<e.length;s++)e[s].n=P(e[s].n)}if(e.length&&(a=!(i.sensor||t.sensor),o)){var n=new Array(e.length);for(s=0;s<e.length;s++)n[s]=new wt(e[s].p,e[s].n,e[s].dist);o(t,n)}}};return this.lock(),this.activeShapes.query(i,e),this.staticShapes.query(i,e),this.unlock(!0),a},Ft.prototype.addPostStepCallback=function(t){g(this.locked,"Adding a post-step callback when the space is not locked is unnecessary. Post-step callbacks will not called until the end of the next call to cpSpaceStep() or the next query."),this.postStepCallbacks.push(t)},Ft.prototype.runPostStepCallbacks=function(){for(var t=0;t<this.postStepCallbacks.length;t++)this.postStepCallbacks[t]();this.postStepCallbacks=[]},Ft.prototype.lock=function(){this.locked++},Ft.prototype.unlock=function(t){if(this.locked--,v(0<=this.locked,"Internal Error: Space lock underflow."),0===this.locked&&t){for(var i=this.rousedBodies,e=0;e<i.length;e++)this.activateBody(i[e]);i.length=0,this.runPostStepCallbacks()}},Ft.prototype.makeCollideShapes=function(){var c=this;return function(t,i){var e=c;if(t.bb_l<=i.bb_r&&i.bb_l<=t.bb_r&&t.bb_b<=i.bb_t&&i.bb_b<=t.bb_t&&t.body!==i.body&&(!t.group||t.group!==i.group)&&t.layers&i.layers){var s=e.lookupHandler(t.collision_type,i.collision_type),n=t.sensor||i.sensor;if(!n||s!==Nt){if(t.collisionCode>i.collisionCode){var r=t;t=i,i=r}var o=Lt(t,i);if(0!==o.length){var a=w(t.hashid,i.hashid),h=e.cachedArbiters[a];h||(h=e.cachedArbiters[a]=new gt(t,i)),h.update(o,s,t,i),"first coll"!=h.state||s.begin(h,e)||h.ignore(),"ignore"!==h.state&&s.preSolve(h,e)&&!n?e.arbiters.push(h):(h.contacts=null,"ignore"!==h.state&&(h.state="normal")),h.stamp=e.stamp}}}}},Ft.prototype.arbiterSetFilter=function(t){var i=this.stamp-t.stamp,e=t.body_a,s=t.body_b;return!(!e.isStatic()&&!e.isSleeping()||!s.isStatic()&&!s.isSleeping())||(1<=i&&"cached"!=t.state&&(t.callSeparate(this),t.state="cached"),!(i>=this.collisionPersistence)||(t.contacts=null,!1))};var Ot=function(t){var i=t.body;t.update(i.p,i.rot)};Ft.prototype.step=function(t){if(0!==t){v(0===j.x&&0===j.y,"vzero is invalid"),this.stamp++;var i,e,s,n=this.curr_dt;this.curr_dt=t;var r=this.bodies,o=this.constraints,a=this.arbiters;for(i=0;i<a.length;i++){var h=a[i];h.state="normal",h.body_a.isSleeping()||h.body_b.isSleeping()||h.unthread()}for(a.length=0,this.lock(),i=0;i<r.length;i++)r[i].position_func(t);for(s in this.activeShapes.each(Ot),this.activeShapes.reindexQuery(this.collideShapes),this.unlock(!1),this.processComponents(t),this.lock(),this.cachedArbiters)this.arbiterSetFilter(this.cachedArbiters[s])||delete this.cachedArbiters[s];var c=this.collisionSlop,p=1-Math.pow(this.collisionBias,t);for(i=0;i<a.length;i++)a[i].preStep(t,c,p);for(i=0;i<o.length;i++){var u=o[i];u.preSolve(this),u.preStep(t)}var l=Math.pow(this.damping,t),b=this.gravity;for(i=0;i<r.length;i++)r[i].velocity_func(b,l,t);var y=0===n?0:t/n;for(i=0;i<a.length;i++)a[i].applyCachedImpulse(y);for(i=0;i<o.length;i++)o[i].applyCachedImpulse(y);for(i=0;i<this.iterations;i++){for(e=0;e<a.length;e++)a[e].applyImpulse();for(e=0;e<o.length;e++)o[e].applyImpulse()}for(i=0;i<o.length;i++)o[i].postSolve(this);for(i=0;i<a.length;i++)a[i].handler.postSolve(a[i],this);this.unlock(!0)}};var qt=function(t,i,e,s){var n=t.vx+-e.y*t.w,r=t.vy+e.x*t.w,o=i.vx+-s.y*i.w,a=i.vy+s.x*i.w;return new S(o-n,a-r)},Et=function(t,i,e,s,n){var r=t.vx+-e.y*t.w,o=t.vy+e.x*t.w,a=i.vx+-s.y*i.w,h=i.vy+s.x*i.w;return M(a-r,h-o,n.x,n.y)},Ht=function(t,i,e,s){t.vx+=i*t.m_inv,t.vy+=e*t.m_inv,t.w+=t.i_inv*(s.x*e-s.y*i)},Dt=function(t,i,e,s,n,r){Ht(t,-n,-r,e),Ht(i,n,r,s)},Gt=function(t,i,e,s){t.v_biasx+=i*t.m_inv,t.v_biasy+=e*t.m_inv,t.w_bias+=t.i_inv*F(s.x,s.y,i,e)},Wt=function(t,i,e){var s=N(i,e);return t.m_inv+t.i_inv*s*s},zt=function(t,i,e,s,n){var r=Wt(t,e,n)+Wt(i,s,n);return g(0!==r,"Unsolvable collision or constraint."),r},Jt=function(t,i,e,s,n,r){var o,a,h,c,p=t.m_inv+i.m_inv;h=a=0,c=o=p;var u=t.i_inv,l=e.x*e.x*u,b=e.y*e.y*u,y=-e.x*e.y*u;o+=b,a+=y,h+=y,c+=l;var v=i.i_inv,f=s.x*s.x*v,d=s.y*s.y*v,_=-s.x*s.y*v,x=(o+=d)*(c+=f)-(a+=_)*(h+=_);g(0!=x,"Unsolvable constraint.");var m=1/x;n.x=c*m,n.y=-a*m,r.x=-h*m,r.y=o*m},Ut=function(t,i,e){return new S(k(t,i),k(t,e))},Yt=function(t,i){return 1-Math.pow(t,i)},Kt=r.Constraint=function(t,i){this.a=t,this.b=i,this.space=null,this.next_a=null,this.next_b=null,this.maxForce=1/0,this.errorBias=Math.pow(.9,60),this.maxBias=1/0};Kt.prototype.activateBodies=function(){this.a&&this.a.activate(),this.b&&this.b.activate()},Kt.prototype.preStep=function(t){},Kt.prototype.applyCachedImpulse=function(t){},Kt.prototype.applyImpulse=function(){},Kt.prototype.getImpulse=function(){return 0},Kt.prototype.preSolve=function(t){},Kt.prototype.postSolve=function(t){},Kt.prototype.next=function(t){return this.a===t?this.next_a:this.next_b};var Xt=r.PinJoint=function(t,i,e,s){Kt.call(this,t,i),this.anchr1=e,this.anchr2=s;var n=t?I(t.p,c(e,t.rot)):e,r=i?I(i.p,c(s,i.rot)):s;this.dist=_(x(r,n)),g(0<this.dist,"You created a 0 length pin joint. A pivot joint will be much more stable."),this.r1=this.r2=null,this.n=null,this.nMass=0,this.jnAcc=this.jnMax=0,this.bias=0};Xt.prototype=Object.create(Kt.prototype),Xt.prototype.preStep=function(t){var i=this.a,e=this.b;this.r1=c(this.anchr1,i.rot),this.r2=c(this.anchr2,e.rot);var s=x(I(e.p,this.r2),I(i.p,this.r1)),n=_(s);this.n=L(s,1/(n||1/0)),this.nMass=1/zt(i,e,this.r1,this.r2,this.n);var r=this.maxBias;this.bias=C(-Yt(this.errorBias,t)*(n-this.dist)/t,-r,r),this.jnMax=this.maxForce*t},Xt.prototype.applyCachedImpulse=function(t){var i=L(this.n,this.jnAcc*t);Dt(this.a,this.b,this.r1,this.r2,i.x,i.y)},Xt.prototype.applyImpulse=function(){var t=this.a,i=this.b,e=this.n,s=Et(t,i,this.r1,this.r2,e),n=(this.bias-s)*this.nMass,r=this.jnAcc;this.jnAcc=C(r+n,-this.jnMax,this.jnMax),n=this.jnAcc-r,Dt(t,i,this.r1,this.r2,e.x*n,e.y*n)},Xt.prototype.getImpulse=function(){return Math.abs(this.jnAcc)};var Zt=r.SlideJoint=function(t,i,e,s,n,r){Kt.call(this,t,i),this.anchr1=e,this.anchr2=s,this.min=n,this.max=r,this.r1=this.r2=this.n=null,this.nMass=0,this.jnAcc=this.jnMax=0,this.bias=0};Zt.prototype=Object.create(Kt.prototype),Zt.prototype.preStep=function(t){var i=this.a,e=this.b;this.r1=c(this.anchr1,i.rot),this.r2=c(this.anchr2,e.rot);var s=x(I(e.p,this.r2),I(i.p,this.r1)),n=_(s),r=0;n>this.max?(r=n-this.max,this.n=h(s)):n<this.min?(r=this.min-n,this.n=P(h(s))):(this.n=j,this.jnAcc=0),this.nMass=1/zt(i,e,this.r1,this.r2,this.n);var o=this.maxBias;this.bias=C(-Yt(this.errorBias,t)*r/t,-o,o),this.jnMax=this.maxForce*t},Zt.prototype.applyCachedImpulse=function(t){var i=this.jnAcc*t;Dt(this.a,this.b,this.r1,this.r2,this.n.x*i,this.n.y*i)},Zt.prototype.applyImpulse=function(){if(0!==this.n.x||0!==this.n.y){var t=this.a,i=this.b,e=this.n,s=this.r1,n=this.r2,r=qt(t,i,s,n),o=k(r,e),a=(this.bias-o)*this.nMass,h=this.jnAcc;this.jnAcc=C(h+a,-this.jnMax,0),a=this.jnAcc-h,Dt(t,i,this.r1,this.r2,e.x*a,e.y*a)}},Zt.prototype.getImpulse=function(){return Math.abs(this.jnAcc)};var $t=r.PivotJoint=function(t,i,e,s){if(Kt.call(this,t,i),void 0===s){var n=e;e=t?t.world2Local(n):n,s=i?i.world2Local(n):n}this.anchr1=e,this.anchr2=s,this.r1=this.r2=j,this.k1=new S(0,0),this.k2=new S(0,0),this.jAcc=j,this.jMaxLen=0,this.bias=j};$t.prototype=Object.create(Kt.prototype),$t.prototype.preStep=function(t){var i=this.a,e=this.b;this.r1=c(this.anchr1,i.rot),this.r2=c(this.anchr2,e.rot),Jt(i,e,this.r1,this.r2,this.k1,this.k2),this.jMaxLen=this.maxForce*t;var s=x(I(e.p,this.r2),I(i.p,this.r1));this.bias=b(L(s,-Yt(this.errorBias,t)/t),this.maxBias)},$t.prototype.applyCachedImpulse=function(t){Dt(this.a,this.b,this.r1,this.r2,this.jAcc.x*t,this.jAcc.y*t)},$t.prototype.applyImpulse=function(){var t=this.a,i=this.b,e=this.r1,s=this.r2,n=qt(t,i,e,s),r=Ut(x(this.bias,n),this.k1,this.k2),o=this.jAcc;this.jAcc=b(I(this.jAcc,r),this.jMaxLen),Dt(t,i,this.r1,this.r2,this.jAcc.x-o.x,this.jAcc.y-o.y)},$t.prototype.getImpulse=function(){return _(this.jAcc)};var ti=r.GrooveJoint=function(t,i,e,s,n){Kt.call(this,t,i),this.grv_a=e,this.grv_b=s,this.grv_n=p(l(x(s,e))),this.anchr2=n,this.grv_tn=null,this.clamp=0,this.r1=this.r2=null,this.k1=new S(0,0),this.k2=new S(0,0),this.jAcc=j,this.jMaxLen=0,this.bias=null};ti.prototype=Object.create(Kt.prototype),ti.prototype.preStep=function(t){var i=this.a,e=this.b,s=i.local2World(this.grv_a),n=i.local2World(this.grv_b),r=c(this.grv_n,i.rot),o=k(s,r);this.grv_tn=r,this.r2=c(this.anchr2,e.rot);var a=N(I(e.p,this.r2),r);a<=N(s,r)?(this.clamp=1,this.r1=x(s,i.p)):a>=N(n,r)?(this.clamp=-1,this.r1=x(n,i.p)):(this.clamp=0,this.r1=x(I(L(p(r),-a),L(r,o)),i.p)),Jt(i,e,this.r1,this.r2,this.k1,this.k2),this.jMaxLen=this.maxForce*t;var h=x(I(e.p,this.r2),I(i.p,this.r1));this.bias=b(L(h,-Yt(this.errorBias,t)/t),this.maxBias)},ti.prototype.applyCachedImpulse=function(t){Dt(this.a,this.b,this.r1,this.r2,this.jAcc.x*t,this.jAcc.y*t)},ti.prototype.grooveConstrain=function(t){var i=this.grv_tn,e=0<this.clamp*N(t,i)?t:s(t,i);return b(e,this.jMaxLen)},ti.prototype.applyImpulse=function(){var t=this.a,i=this.b,e=this.r1,s=this.r2,n=qt(t,i,e,s),r=Ut(x(this.bias,n),this.k1,this.k2),o=this.jAcc;this.jAcc=this.grooveConstrain(I(o,r)),Dt(t,i,this.r1,this.r2,this.jAcc.x-o.x,this.jAcc.y-o.y)},ti.prototype.getImpulse=function(){return _(this.jAcc)},ti.prototype.setGrooveA=function(t){this.grv_a=t,this.grv_n=p(l(x(this.grv_b,t))),this.activateBodies()},ti.prototype.setGrooveB=function(t){this.grv_b=t,this.grv_n=p(l(x(t,this.grv_a))),this.activateBodies()};var ii=function(t,i){return(t.restLength-i)*t.stiffness},ei=r.DampedSpring=function(t,i,e,s,n,r,o){Kt.call(this,t,i),this.anchr1=e,this.anchr2=s,this.restLength=n,this.stiffness=r,this.damping=o,this.springForceFunc=ii,this.target_vrn=this.v_coef=0,this.r1=this.r2=null,this.nMass=0,this.n=null};ei.prototype=Object.create(Kt.prototype),ei.prototype.preStep=function(t){var i=this.a,e=this.b;this.r1=c(this.anchr1,i.rot),this.r2=c(this.anchr2,e.rot);var s=x(I(e.p,this.r2),I(i.p,this.r1)),n=_(s);this.n=L(s,1/(n||1/0));var r=zt(i,e,this.r1,this.r2,this.n);g(0!==r,"Unsolvable this."),this.nMass=1/r,this.target_vrn=0,this.v_coef=1-Math.exp(-this.damping*t*r);var o=this.springForceFunc(this,n);Dt(i,e,this.r1,this.r2,this.n.x*o*t,this.n.y*o*t)},ei.prototype.applyCachedImpulse=function(t){},ei.prototype.applyImpulse=function(){var t=this.a,i=this.b,e=this.n,s=this.r1,n=this.r2,r=Et(t,i,s,n,e),o=(this.target_vrn-r)*this.v_coef;this.target_vrn=r+o,o*=this.nMass,Dt(t,i,this.r1,this.r2,this.n.x*o,this.n.y*o)},ei.prototype.getImpulse=function(){return 0};var si=function(t,i){return(i-t.restAngle)*t.stiffness},ni=r.DampedRotarySpring=function(t,i,e,s,n){Kt.call(this,t,i),this.restAngle=e,this.stiffness=s,this.damping=n,this.springTorqueFunc=si,this.target_wrn=0,this.w_coef=0,this.iSum=0};ni.prototype=Object.create(Kt.prototype),ni.prototype.preStep=function(t){var i=this.a,e=this.b,s=i.i_inv+e.i_inv;g(0!==s,"Unsolvable spring."),this.iSum=1/s,this.w_coef=1-Math.exp(-this.damping*t*s),this.target_wrn=0;var n=this.springTorqueFunc(this,i.a-e.a)*t;i.w-=n*i.i_inv,e.w+=n*e.i_inv},ni.prototype.applyImpulse=function(){var t=this.a,i=this.b,e=t.w-i.w,s=(this.target_wrn-e)*this.w_coef;this.target_wrn=e+s;var n=s*this.iSum;t.w+=n*t.i_inv,i.w-=n*i.i_inv};var ri=r.RotaryLimitJoint=function(t,i,e,s){Kt.call(this,t,i),this.min=e,this.max=s,this.jAcc=0,this.iSum=this.bias=this.jMax=0};ri.prototype=Object.create(Kt.prototype),ri.prototype.preStep=function(t){var i=this.a,e=this.b,s=e.a-i.a,n=0;s>this.max?n=this.max-s:s<this.min&&(n=this.min-s),this.iSum=1/(1/i.i+1/e.i);var r=this.maxBias;this.bias=C(-Yt(this.errorBias,t)*n/t,-r,r),this.jMax=this.maxForce*t,this.bias||(this.jAcc=0)},ri.prototype.applyCachedImpulse=function(t){var i=this.a,e=this.b,s=this.jAcc*t;i.w-=s*i.i_inv,e.w+=s*e.i_inv},ri.prototype.applyImpulse=function(){if(this.bias){var t=this.a,i=this.b,e=i.w-t.w,s=-(this.bias+e)*this.iSum,n=this.jAcc;this.bias<0?this.jAcc=C(n+s,0,this.jMax):this.jAcc=C(n+s,-this.jMax,0),s=this.jAcc-n,t.w-=s*t.i_inv,i.w+=s*i.i_inv}},ri.prototype.getImpulse=function(){return Math.abs(joint.jAcc)};var oi=r.RatchetJoint=function(t,i,e,s){Kt.call(this,t,i),this.angle=0,this.phase=e,this.ratchet=s,this.angle=(i?i.a:0)-(t?t.a:0),this.iSum=this.bias=this.jAcc=this.jMax=0};oi.prototype=Object.create(Kt.prototype),oi.prototype.preStep=function(t){var i=this.a,e=this.b,s=this.angle,n=this.phase,r=this.ratchet,o=e.a-i.a,a=s-o,h=0;0<a*r?h=a:this.angle=Math.floor((o-n)/r)*r+n,this.iSum=1/(i.i_inv+e.i_inv);var c=this.maxBias;this.bias=C(-Yt(this.errorBias,t)*h/t,-c,c),this.jMax=this.maxForce*t,this.bias||(this.jAcc=0)},oi.prototype.applyCachedImpulse=function(t){var i=this.a,e=this.b,s=this.jAcc*t;i.w-=s*i.i_inv,e.w+=s*e.i_inv},oi.prototype.applyImpulse=function(){if(this.bias){var t=this.a,i=this.b,e=i.w-t.w,s=this.ratchet,n=-(this.bias+e)*this.iSum,r=this.jAcc;this.jAcc=C((r+n)*s,0,this.jMax*Math.abs(s))/s,n=this.jAcc-r,t.w-=n*t.i_inv,i.w+=n*i.i_inv}},oi.prototype.getImpulse=function(t){return Math.abs(t.jAcc)};var ai=r.GearJoint=function(t,i,e,s){Kt.call(this,t,i),this.phase=e,this.ratio=s,this.ratio_inv=1/s,this.jAcc=0,this.iSum=this.bias=this.jMax=0};ai.prototype=Object.create(Kt.prototype),ai.prototype.preStep=function(t){var i=this.a,e=this.b;this.iSum=1/(i.i_inv*this.ratio_inv+this.ratio*e.i_inv);var s=this.maxBias;this.bias=C(-Yt(this.errorBias,t)*(e.a*this.ratio-i.a-this.phase)/t,-s,s),this.jMax=this.maxForce*t},ai.prototype.applyCachedImpulse=function(t){var i=this.a,e=this.b,s=this.jAcc*t;i.w-=s*i.i_inv*this.ratio_inv,e.w+=s*e.i_inv},ai.prototype.applyImpulse=function(){var t=this.a,i=this.b,e=i.w*this.ratio-t.w,s=(this.bias-e)*this.iSum,n=this.jAcc;this.jAcc=C(n+s,-this.jMax,this.jMax),s=this.jAcc-n,t.w-=s*t.i_inv*this.ratio_inv,i.w+=s*i.i_inv},ai.prototype.getImpulse=function(){return Math.abs(this.jAcc)},ai.prototype.setRatio=function(t){this.ratio=t,this.ratio_inv=1/t,this.activateBodies()};var hi=r.SimpleMotor=function(t,i,e){Kt.call(this,t,i),this.rate=e,this.jAcc=0,this.iSum=this.jMax=0};hi.prototype=Object.create(Kt.prototype),hi.prototype.preStep=function(t){this.iSum=1/(this.a.i_inv+this.b.i_inv),this.jMax=this.maxForce*t},hi.prototype.applyCachedImpulse=function(t){var i=this.a,e=this.b,s=this.jAcc*t;i.w-=s*i.i_inv,e.w+=s*e.i_inv},hi.prototype.applyImpulse=function(){var t=this.a,i=this.b,e=-(i.w-t.w+this.rate)*this.iSum,s=this.jAcc;this.jAcc=C(s+e,-this.jMax,this.jMax),e=this.jAcc-s,t.w-=e*t.i_inv,i.w+=e*i.i_inv},hi.prototype.getImpulse=function(){return Math.abs(this.jAcc)}}();
